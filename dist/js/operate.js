window,{init:function(){this.pageDates={one:null,two:null},this.getDateUrl={lineTypeUrl:"/sys/main?xwl=34580M8L7PLG",lineListUrl:"/sys/main?xwl=34580M8L7SVI",productSale:"/sys/main?xwl=34580M8L7YGV",productBusiness:"/sys/main?xwl=34580M8L8TBM"},this.searchDates={timeType:"month",operate_type:"",lineTypeID:"",lineID:"",startdate:"",enddate:""},this.pageLoads={0:!1,1:!1},this.nowPageIndex=0,this.nowTime=new Date,this.searchDates.startdate=this.setQueryTimeTool(3),this.searchDates.enddate=this.getTimeString(new Date),this._init()},_init:function(){this.initNodes(),this.searchEvents(),this.createSwiper(),this.loadPage(0),this.pageShowTime()},initNodes:function(){this.pageShowTimeNode=$("#Js_page_showTime"),this.selectQueryTime=$("#Js_select_queryTime"),this.pageTitle=$("#Js_pageTitle"),this.saleFdScroll=$("#Js_fdScroll"),this.onePageSelect=$("#Js_onePage_select"),this.searchTimeSelect=$("#Js_Search_timeSelect"),this.searchStartDate=$("#Js_startDate"),this.searchEndDate=$("#Js_endDate"),this.pageOneCxt=$("#Js_saleNum"),this.pageTwoCxt=$("#Js_optNum"),this.saleChartNode=echarts.init(document.getElementById("Js_saleNum")),this.optEchartNodes=echarts.init(document.getElementById("Js_optNum"))},toNum:function(e){return e<10?"0"+e:e},showLoading:function(){this.loadNode=weui.loading("加载中...")},pageShowTime:function(){this.pageShowTimeNode.html("[ "+this.searchDates.startdate+" — "+this.searchDates.enddate+" ]")},hideLoading:function(){this.loadNode.hide()},getTimeItem:function(e,t){if(e&&e.length>=10)switch(t){case"Y":return parseInt(e.substr(0,4));case"m":return parseInt(e.substr(5,2));case"d":return parseInt(e.substr(8,2))}return""},searchEvents:function(){var e=this,t=(new Date,$("#Js_searchPanel"));$("#Js_screen").click(function(){t.addClass("s-show")}),this.onePageSelect.on("click",function(t){var a=$(t.target);a.addClass("active").siblings(".item").removeClass("active"),e.searchTimeSelect.find(".s-click").removeClass("active").eq(a.attr("data-index")).addClass("active"),e.searchDates.timeType=a.attr("data-type"),e.pageLoads={0:!1,1:!1},e.loadPage(e.nowPageIndex)}),t.on("click",function(a){var s=$(a.target);if(s.hasClass("btn-true")&&(t.removeClass("s-show"),e.pageLoads={0:!1,1:!1},e.loadPage(e.nowPageIndex),e.pageShowTime()),s.hasClass("back")&&t.removeClass("s-show"),s.hasClass("s-start")&&weui.datePicker({start:2012,defaultValue:[e.getTimeItem(e.searchDates.startdate,"Y"),e.getTimeItem(e.searchDates.startdate,"m"),e.getTimeItem(e.searchDates.startdate,"d")],end:e.searchDates.enddate,onConfirm:function(t){e.searchDates.startdate=t[0].value+"-"+e.toNum(t[1].value)+"-"+e.toNum(t[2].value),s.val(e.searchDates.startdate),e.selectQueryTime.find(".s-click").removeClass("active")}}),s.hasClass("s-end")&&weui.datePicker({start:e.searchDates.startdate,defaultValue:[e.getTimeItem(e.searchDates.enddate,"Y"),e.getTimeItem(e.searchDates.enddate,"m"),e.getTimeItem(e.searchDates.enddate,"d")],onConfirm:function(t){e.searchDates.enddate=t[0].value+"-"+e.toNum(t[1].value)+"-"+e.toNum(t[2].value),s.val(e.searchDates.enddate),e.selectQueryTime.find(".s-click").removeClass("active")}}),s.hasClass("s-click")&&!s.hasClass("active")&&("timeType"===s.parent().attr("data-text")&&e.onePageSelect.find(".item").removeClass("active").eq(s.attr("data-index")).addClass("active"),e.searchDates[s.parent().attr("data-text")]=s.attr("data-type"),s.addClass("active").siblings(".s-click").removeClass("active"),"dataTimes"===s.parent().attr("data-text")&&e.setQueryTime(parseInt(s.attr("data-type")))),s.hasClass("s-lineType")){var i=s.parent().find(".s-input");e.showLoading(),$.post(e.getDateUrl.lineTypeUrl,{query:i.val(),operate_type:e.searchDates.operate_type},function(t){e.hideLoading(),weui.picker(t.rows.length>0?t.rows:[{value:"",label:"暂无类别"}],{onConfirm:function(t){e.searchDates.lineTypeID=t[0].value,i.val(t[0].label),$("#Js_lineId_search").val("")}})},"json")}if(s.hasClass("s-line")){var n=s.parent().find(".s-input");e.showLoading(),$.post(e.getDateUrl.lineListUrl,{query:n.val(),operate_type:e.searchDates.operate_type,lineTypeID:e.searchDates.lineTypeID},function(t){e.hideLoading(),weui.picker(t.rows.length>0?t.rows:[{value:"",label:"暂无类别"}],{onConfirm:function(a){if(a[0].value)for(var s=0,i=t.rows.length;s<i;s++)if(t.rows[s].value==a[0].value){e.searchDates.lineTypeID=t.rows[s].LineTypeID,$("#Js_lineTypeId_search").val(t.rows[s].LineTypeName);break}e.searchDates.lineID=a[0].value,n.val(a[0].label)}})},"json")}}),t.on("input propertychange",".s-input",function(t){var a=$(t.target);a.val()||(e.searchDates[a.attr("data-text")]="")})},getTimeString:function(e){if(e&&"object"==typeof e){var t=[e.getFullYear(),this.toNum(e.getMonth()+1),this.toNum(e.getDate())];return t[0]+"-"+t[1]+"-"+t[2]}},setQueryTimeTool:function(e){var t=new Date;return 0===e?(t.setMonth(0),t.setDate(1)):t.setMonth(t.getMonth()-e),this.getTimeString(t)},setQueryTime:function(e){var t=new Date;0===e?(t.setMonth(0),t.setDate(1)):t.setMonth(t.getMonth()-e),this.searchDates.startdate=this.getTimeString(t),this.searchDates.enddate=this.getTimeString(this.nowTime),this.searchStartDate.val(this.searchDates.startdate),this.searchEndDate.val(this.searchDates.enddate)},createSwiper:function(){var e=this;new Swiper(".swiper-container",{direction:"vertical",loop:!1,initialSlide:0,onSlideChangeEnd:function(t){switch(e.nowPageIndex=t.realIndex,0===t.realIndex&&e.saleFdScroll.removeClass("prev").addClass("next").text("上滑查看更多"),t.realIndex===t.slidesSizesGrid.length-1&&e.saleFdScroll.removeClass("next").addClass("prev").text("最后一页了"),e.nowPageIndex){case 0:e.saleNums(),e.pageLoads[0]||e.loadPage(0);break;case 1:e.optNums(),e.pageLoads[1]||e.loadPage(1)}e.loadPage(e.pageNum)}})},loadPage:function(e){var t=this;switch(e===this.nowPageIndex&&this.showLoading(),e){case 0:this.pageTitle.text("产品销量分析"),$.post(this.getDateUrl.productSale,this.searchDates,function(a){t.pageDates.one=a.baseLineSalesVolume||[],t.pageLoads[e]=!0,t.hideLoading(),t.nowPageIndex===e&&t.saleNums(),t.pageLoads[1]||t.loadPage(1)},"json");break;case 1:this.pageTitle.text("产品营业情况分析"),$.post(this.getDateUrl.productBusiness,this.searchDates,function(a){t.pageDates.two=a.baseLineIncome||[],t.pageLoads[e]=!0,t.hideLoading(),t.nowPageIndex===e&&t.optNums(),t.pageLoads[0]||t.loadPage(0)},"json")}},saleNumConfig:function(e,t,a,s,i,n){return{color:["#ffdf2b","#28ff79","#0ab2f9"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(e,t,a){return e[0].name+"<br/>"+e[0].seriesName+": "+e[0].data+"<br/>"+e[1].seriesName+": "+e[1].data+"<br/>"+e[2].seriesName+": "+e[2].data+"<br/>总库存："+n[e[0].dataIndex]}},legend:{data:[{name:"剩余库存",textStyle:{color:"#3bcaff"}},{name:"预留人数",textStyle:{color:"#3bcaff"}},{name:"确认人数",textStyle:{color:"#3bcaff"}}],top:0,right:10},textStyle:{color:"#33b4eb"},dataZoom:{show:!0,type:"inside",realtime:!0,start:0,end:e},grid:{show:!0,left:"10",right:"0",top:"30",bottom:"5",containLabel:!0,borderColor:"#33b4eb",borderWidth:0,shadowBlur:0},xAxis:[{type:"category",data:t,axisTick:{alignWithLabel:!0},axisLine:{show:!0,lineStyle:{width:0,color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{width:0,color:"#0e5f97"}}}],yAxis:[{type:"value",axisLine:{lineStyle:{color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{color:"#0e5f97"}}}],series:[{name:"确认人数",type:"bar",barWidth:20,stack:"收入",data:i},{name:"预留人数",type:"bar",barWidth:20,stack:"收入",data:s},{name:"剩余库存",type:"bar",barWidth:20,stack:"收入",data:a}]}},saleNums:function(){if(!this.pageLoads[0])return this.showLoading(),!1;var e=this.pageDates.one.length||1;e=e<10?10:e;var t=Math.floor(1e3/e),a=[],s=[],i=[],n=[],o=[];this.pageDates.one.length,this.pageDates.one.forEach(function(e,t){a.push(e.planDate),i.push(e.planNum-e.trueNum-e.stayNum),s.push(e.planNum),n.push(e.stayNum),o.push(e.trueNum)}),a.push(""),i.push(""),n.push(""),o.push(""),this.saleChartNode.setOption(this.saleNumConfig(t,a,i,n,o,s))},optNumConfig:function(e,t,a,s){return{color:["#0ab2f9","#d03547"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{data:[{name:"收入",textStyle:{color:"#3bccff"}},{name:"毛利",textStyle:{color:"#3bccff"}}],top:0,right:10},textStyle:{color:"#33b4eb"},dataZoom:{show:!0,type:"inside",realtime:!0,start:0,end:e},grid:{show:!0,left:"20",right:"0",top:"30",bottom:"5",containLabel:!0,borderColor:"#33b4eb",borderWidth:0,shadowBlur:0},xAxis:[{type:"category",data:t,axisTick:{alignWithLabel:!1},axisLine:{lineStyle:{width:0,color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{width:0,color:"#0e5f97"}}}],yAxis:[{type:"value",axisLine:{lineStyle:{color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{color:"#0e5f97"}},axisLabel:{formatter:"￥{value}"}}],series:[{name:"收入",type:"bar",barWidth:20,stack:"收入",data:a},{name:"毛利",type:"bar",barWidth:20,stack:"收入",data:s}]}},optNums:function(){if(!this.pageLoads[1])return this.showLoading(),!1;var e=this.pageDates.two.length||1;e=e<10?10:e;var t=Math.floor(1e3/e),a=[],s=[],i=[];this.pageDates.two.forEach(function(e,t){a.push(Number(e.amount).toFixed(2)),s.push(Number(e.profitAmount).toFixed(2)),i.push(e.planDate)}),a.push(""),s.push(""),i.push(""),this.optEchartNodes.setOption(this.optNumConfig(t,i,a,s))}}.init();