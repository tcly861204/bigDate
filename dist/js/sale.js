!function(e){for(var t=0,a=["","webkit","moz"],s=0;s<a.length&&!e.requestAnimationFrame;++s)e.requestAnimationFrame=e[a[s]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[a[s]+"CancelAnimationFrame"]||e[a[s]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(a,s){var i=(new Date).getTime(),n=Math.max(0,16.7-(i-t)),l=e.setTimeout(function(){a(i+n)},n);return t=i+n,l}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(e){clearTimeout(e)}),{init:function(){this._scaleBit=4,this.pageNum=0,this.pageDates={yeji:null,shouke:null,dingdnalaiyuan:null,kedan:null,lirun:null,leibie:null,chanpin:null},this.allFaceList="",this._winfo=document.body.getBoundingClientRect(),this._ww=this._winfo.width,this._wh=this._winfo.height,this._rem=this._ww/25,this.getDateUrl={sale:"/sys/main?xwl=34580M8L8X9A",itemSale:"/sys/api/1.0.0/big-date/dsj-api-itemSaleInfos",deepSale:"/sys/api/1.0.0/big-date/dsj-api-pageAlls"},this.nowTime=new Date,this.searchDate={saleID:"",saleName:"",saleFace:"",deptName:"",operate_type:"",dateType:"出团日期",startdate:this.setQueryTime(1),enddate:this.getTimeString(this.nowTime)},this.faceListSearch=$("#Js_faceList"),this.faceListStart=$("#Js_s_faceList"),this._init()},saleListTpl:function(e){return'<li class="item" data-id="'+e.saleID+'" data-name="'+e.saleName+'" data-face="'+(e.head_photo?e.head_photo:"http://cdnfile.op110.com.cn/files/1/file/20170727/face_1501143964193.jpg")+'">\n                    <img class="face" src="'+(e.head_photo?e.head_photo:"http://cdnfile.op110.com.cn/files/1/file/20170727/face_1501143964193.jpg")+'">\n                    <span class="user eps">'+e.saleName+"</span>\n                </li>"},sfaceListTpl:function(e){return'<dl class="face-item" data-id="'+e.saleID+'" data-name="'+e.saleName+'" data-face="'+(e.head_photo?e.head_photo:"http://cdnfile.op110.com.cn/files/1/file/20170727/face_1501143964193.jpg")+'">\n                    <dt>\n                        <img class="user-face" src="'+(e.head_photo?e.head_photo:"http://cdnfile.op110.com.cn/files/1/file/20170727/face_1501143964193.jpg")+'" />\n                    </dt>\n                    <dd class="user-name eps">'+e.saleName+"</dd>\n                </dl>"},saleInfoPageOneTpl:function(e){return'<dl class="saleInfo">\n                    <dt class="face">\n                        <img src="'+(e.head_photo?e.head_photo:"http://cdnfile.op110.com.cn/files/1/file/20170727/face_1501143964193.jpg")+'" />\n                    </dt>\n                    \x3c!--sex-woman 女--\x3e\n                    <dd class="user sex-man">'+e.saleName+'<span class="icon icon-'+("男"===e.sex?"man":"女"===e.sex?"woman":"")+'"></span></dd>\n                    <dd class="item">出生日期<span class="v">'+(e.birthday?e.birthday.substring(0,10):"-")+'</span></dd>\n                    <dd class="item fr">年龄<span class="v">'+this.birthdayFn(e.birthday)+'</span></dd>\n                    <dd class="item" style="width: 14rem;">入职时长<span class="v">'+this.birthdayFn(e.entryData)+'年</span></dd>\n                </dl>\n                <dl class="amounts">\n                    <dt>\n                        <p class="title">未回款金额</p>\n                        <strong class="no-amount amount">'+this.formatNum(e.pingAmountNo)+'</strong>\n                    </dt>\n                    <dd>\n                        <p class="title">当前客户量</p>\n                        <strong class="psn">'+e.perNumTrue+'</strong>\n                    </dd>\n                    <dd>\n                        <p class="title">订单取消率</p>\n                        <strong class="bit">'+e.perNumNoRate+'</strong>\n                    </dd>\n                    <dd>\n                        <p class="title">订单成功率</p>\n                        <strong class="bit">'+e.perNumTrueRate+'</strong>\n                    </dd>\n                    <dd>\n                        <p class="title">单月最高收客</p>\n                        <strong class="psn">'+e.monthHighPerNum+'</strong>\n                        <span class="time">['+e.monthHighPerNumMonth+"]</span>\n                    </dd>\n                </dl>"},getItemSaleTpl:function(){return'<dt class="face"><img src="'+(this.searchDate.saleFace?this.searchDate.saleFace:"http://cdnfile.op110.com.cn/files/1/file/20170727/face_1501143964193.jpg")+'" /></dt>\n                <dd class="user eps">'+this.searchDate.saleName+'</dd>\n                <dd class="job eps">'+(this.searchDate.deptName||"")+"</dd>"},birthdayFn:function(e){if(e&&e.length>=10&&e.split("-").length>2){var t=e.substring(0,4),a=e.substr(5,2),s=e.substr(8,2),i=new Date,n=i.getFullYear()+"",l=this.toNum(i.getMonth()+1)+"",r=this.toNum(i.getDate())+"";return Math.floor((parseInt(n+l+r)-parseInt(t+a+s))/1e4)}return"-"},getSaleFaceList:function(e,t,a){void 0===e&&(e="");var s=this;this.showLoading(),$.post(this.getDateUrl.sale,{saleName:e},function(e){if(s.hideLoading(),e.saleWhole.length){var i="";s.allFaceList||(s.allFaceList=e.saleWhole),$.each(e.saleWhole,function(e,t){"default"===a&&(i+=s.saleListTpl(t)),"search"===a&&(i+=s.sfaceListTpl(t))}),t.html(i)}else t.html('<p class="nodeDate">暂无数据</p>')},"json")},initDate:function(){this.getSaleFaceList("",this.faceListStart,"default")},showLoading:function(){this.loadNode=weui.loading("加载中...")},hideLoading:function(){this.loadNode.hide()},sfaceListEvents:function(){var e=$("#Js_saleList_panel"),t=this;e.on("click",function(a){var s=$(a.target);if(s.hasClass("face")){var i=s.parent();i.addClass("active").siblings(".item").removeClass("active"),e.removeClass("s-show"),t.searchDate.saleID=i.attr("data-id"),t.searchDate.saleName=i.attr("data-name"),t.searchDate.saleFace=i.attr("data-face"),t.loadPage()}if(s.hasClass("s-btn")){var n=e.find(".s-skey").val();t.getSaleFaceList(n,t.faceListStart,"default")}s.hasClass("btn-jump")&&(e.removeClass("s-show"),t.loadPage())})},initNodes:function(){this.searchStartDate=$("#Js_startDate"),this.searchEndDate=$("#Js_endDate"),this.pageShowTimeNode=$("#Js_page_showTime"),this.pageTitle=$("#Js_pageTitle"),this.saleFdScroll=$("#Js_fdScroll"),this.pageOneInfosNode=$("#Js_pageOne_saleInfo"),this.achievementNodes=$("#Js_achievement"),this.saleTypeBitNodes=$("#Js_saleTypeBit"),this.selectQueryTime=$("#Js_select_queryTime")},_init:function(){this.initNodes(),this.sfaceListEvents(),this.searchEvents(),this.createSwiper(),this.initDate(),this.pageShowTime()},toNum:function(e){return e<10?"0"+e:e},getTimeItem:function(e,t){if(e&&e.length>=10)switch(t){case"Y":return parseInt(e.substr(0,4));case"m":return parseInt(e.substr(5,2));case"d":return parseInt(e.substr(8,2))}return""},resetSaleFace:function(){var e=this,t="";$.each(this.allFaceList,function(a,s){t+=e.sfaceListTpl(s)}),this.faceListSearch.html(t)},searchEvents:function(){var e=this,t=(new Date,$("#Js_searchPanel")),a=$("#Js_faceList"),s="";$("#Js_screen").click(function(){t.addClass("s-show"),e.resetSaleFace()}),t.on("click",function(i){var n=$(i.target);if(n.hasClass("btn-true")&&(t.removeClass("s-show"),e.pageShowTime(),e.loadPage()),n.hasClass("back")&&t.removeClass("s-show"),n.hasClass("s-face-btn")&&(s=n.parent().find(".s-input").val(),e.getSaleFaceList(s,e.faceListSearch,"search")),n.hasClass("user-face")||n.hasClass("user-name")){var l=null;l=n.hasClass("user-face")?n.parent().parent():n.parent(),e.searchDate.saleID=l.attr("data-id"),e.searchDate.saleName=l.attr("data-name"),e.searchDate.saleFace=l.attr("data-face"),l.addClass("active").siblings(".face-item").removeClass("active")}n.hasClass("s-start")&&weui.datePicker({start:2012,defaultValue:[e.getTimeItem(e.searchDate.startdate,"Y"),e.getTimeItem(e.searchDate.startdate,"m"),e.getTimeItem(e.searchDate.startdate,"d")],end:e.searchDate.enddate,onConfirm:function(t){e.searchDate.startdate=t[0].value+"-"+e.toNum(t[1].value)+"-"+e.toNum(t[2].value),n.val(e.searchDate.startdate),e.selectQueryTime.find(".s-click").removeClass("active")}}),n.hasClass("s-end")&&weui.datePicker({start:e.searchDate.startdate,defaultValue:[e.getTimeItem(e.searchDate.enddate,"Y"),e.getTimeItem(e.searchDate.enddate,"m"),e.getTimeItem(e.searchDate.enddate,"d")],onConfirm:function(t){e.searchDate.enddate=t[0].value+"-"+e.toNum(t[1].value)+"-"+e.toNum(t[2].value),n.val(e.searchDate.enddate),e.selectQueryTime.find(".s-click").removeClass("active")}}),n.hasClass("dropLoadMax")&&(a.hasClass("max")?(n.addClass("max"),a.removeClass("max")):(n.removeClass("max"),a.addClass("max"))),n.hasClass("s-click")&&!n.hasClass("active")&&(e.searchDate[n.parent().attr("data-text")]=n.attr("data-type"),n.addClass("active").siblings(".s-click").removeClass("active"),"dataTimes"===n.parent().attr("data-text")&&e.setQueryTime(parseInt(n.attr("data-type"))))})},getTimeString:function(e){if(e&&"object"==typeof e){var t=[e.getFullYear(),this.toNum(e.getMonth()+1),this.toNum(e.getDate())];return t[0]+"-"+t[1]+"-"+t[2]}},setQueryTime:function(e){var t=new Date;0===e?(t.setMonth(0),t.setDate(1)):t.setMonth(t.getMonth()-e),this.searchDate.startdate=this.getTimeString(t),this.searchDate.enddate=this.getTimeString(this.nowTime),this.searchStartDate.val(this.searchDate.startdate),this.searchEndDate.val(this.searchDate.enddate)},createSwiper:function(){var e=this;new Swiper(".swiper-container",{direction:"vertical",autoHeight:!0,loop:!1,initialSlide:0,onSlideChangeEnd:function(t){0===t.realIndex&&e.saleFdScroll.removeClass("prev").addClass("next").text("上滑查看更多"),t.realIndex===t.slidesSizesGrid.length-1&&e.saleFdScroll.removeClass("next").addClass("prev").text("下滑查看更多"),e.pageNum=t.realIndex,e.loadPage()}})},loadDatePages:function(e,t){var a=this;this.showLoading(),this.searchDate.pageType=e,$.post(this.getDateUrl.deepSale,this.searchDate,function(s){a.pageDates[e]=s,a.hideLoading(),t.call(a)},"json")},setPageItemSale:function(e){$("#Js_pageInfo_sale_"+e).html(this.getItemSaleTpl())},pageShowTime:function(){this.pageShowTimeNode.html("[ "+this.searchDate.startdate+" — "+this.searchDate.enddate+" ]")},loadPage:function(){var e=this.pageNum;switch(e){case 0:this.pageTitle.text("基本信息"),this.getSaleInfos();break;case 1:this.pageTitle.text("业绩走势"),this.setPageItemSale(e),this.loadDatePages("yeji",this.achievement);break;case 2:this.pageTitle.text("收客人数"),this.setPageItemSale(e),this.loadDatePages("shouke",this.saloon);break;case 3:this.pageTitle.text("订单利润与亏损占比"),this.setPageItemSale(e),this.loadDatePages("lirun",this.profit);break;case 4:this.pageTitle.text("产品类别销售占比"),this.setPageItemSale(e),this.loadDatePages("chanpin",this.saleTypeBit);break;case 5:this.pageTitle.text("客单价区间销量占比"),this.setPageItemSale(e),this.loadDatePages("kedan",this.unitPrice)}},getSaleInfos:function(){var e=this;this.showLoading(),$.post(this.getDateUrl.itemSale,e.searchDate,function(t){e.hideLoading(),e.searchDate.saleName=t.saleSingles.saleName,e.searchDate.saleID=t.saleSingles.saleID,e.searchDate.deptName=t.saleSingles.deptName,t.saleSingles&&e.pageOneInfosNode.html(e.saleInfoPageOneTpl(t.saleSingles))},"json")},formatNum:function(e){var t=e.toString().split("."),a=t[0],s="00";t.length>1&&(s=t[1]);return a.replace(/(?=(?!(\b))(\d{3})+$)/g,",")+Number("0."+s).toFixed(2).substring(1)},achievement:function(){var e=this.pageDates.yeji.saleAchievement||[],t=e.length||1;t=t<10?10:t;var a=Math.floor(1e3/t),s=[],i=[],n=0;e.forEach(function(e,t){s.push(e.addTimeYearMonth),i.push(e.amount),n+=Number(e.amount)}),s.push(""),i.push(""),$("#Js_page_1_title").text(this.formatNum(n));var l=echarts.init(document.getElementById("Js_achievement")),r={color:["#33b4eb"],textStyle:{color:"#33b4eb"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},dataZoom:{show:!0,type:"inside",realtime:!0,start:0,end:a},grid:{show:!0,left:"10",right:"0",top:"10",bottom:"5",containLabel:!0,borderColor:"#33b4eb",borderWidth:0,shadowBlur:0},xAxis:[{type:"category",data:s,axisTick:{alignWithLabel:!0},axisLine:{lineStyle:{width:0,color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{width:0,color:"#0e5f97"}}}],yAxis:[{type:"value",axisLine:{lineStyle:{color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{color:"#0e5f97"}},axisLabel:{formatter:"￥{value}"}}],series:[{name:"营业额",type:"bar",barWidth:20,data:i}]};l.setOption(r)},saloon:function(){var e=0,t=this.pageDates.shouke.salePerNumTrend||[],a=1e3/((t.length||1)<10?10:t.length),s=[],i=[];t.forEach(function(t,a){s.push(t.addTimeYearMonth),i.push(t.perNum),e+=Number(t.perNum)}),s.push(""),i.push(""),$("#Js_page_2_title").text(e);var n=echarts.init(document.getElementById("Js_saloon")),l={color:["ffd800"],textStyle:{color:"#33b4eb"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},dataZoom:{show:!0,type:"inside",realtime:!0,start:0,end:a},grid:{show:!0,left:"10",right:"0",top:"10",bottom:"5",containLabel:!0,borderColor:"#33b4eb",borderWidth:0,shadowBlur:0},xAxis:[{type:"category",data:s,axisTick:{alignWithLabel:!0},axisLine:{lineStyle:{width:0,color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{width:0,color:"#0e5f97"}}}],yAxis:[{type:"value",axisLine:{lineStyle:{color:"#33b4eb"}},splitLine:{show:!0,lineStyle:{color:"#0e5f97"}},axisLabel:{formatter:"{value}人"}}],series:[{name:"收 客",type:"line",smooth:!0,lineStyle:{normal:{color:"#ffd800",width:3,shadowColor:"rgba(0,0,0,0.4)",shadowBlur:10,shadowOffsetY:10}},itemStyle:{normal:{color:"#ffd800",width:3,shadowColor:"rgba(0,0,0,0.4)",shadowBlur:10,shadowOffsetY:10}},data:i}]};n.setOption(l)},profit:function(){var t=this,a=this.pageDates.lirun.saleProfitLoss,s=$("#Js_profit_loss"),i=(s.height(),s.find(".item-hd").height()),n=s.find(".ctx");n.parent().css("width",i);var l=[{color:"#3bccff",bit:Number(a.profit.saleProfitPercentage||0),iNum:0,deg:0,timer:0,amount:a.profit.saleProfitAmount},{color:"#715eff",bit:Number(a.loss.saleLossPercentage||0),iNum:0,deg:0,timer:0,amount:a.loss.saleLossAmount}];l.forEach(function(e,t){s.find(".item").eq(t).find(".bit").html((e.bit?e.bit.toFixed(2):"0")+"<span>%</span>"),s.find(".item").eq(t).find(".pst").html("<span>￥</span>"+Math.abs(e.amount||0))}),n.attr({width:i*t._scaleBit,height:i*t._scaleBit}),n.each(function(a,s){var i=s.getContext("2d"),n=s.width/2,r=20*t._scaleBit;!function t(){i.clearRect(0,0,s.width,s.height),i.beginPath(),i.lineWidth=r,i.strokeStyle="#0e3c6c",i.arc(n,n,n-r/2,0,2*Math.PI),i.stroke(),i.beginPath(),i.strokeStyle=l[a].color,l[a].deg=(l[a].iNum-25)/50*Math.PI,i.arc(n,n,n-r/2,-.5*Math.PI,l[a].deg),i.stroke(),l[a].iNum+=2,l[a].iNum>l[a].bit?e.cancelAnimationFrame(l[a].timer):l[a].timer=e.requestAnimationFrame(t)}()})},salePropCvs:function(t,a,s){var i=document.querySelector("#Js_saleType_"+t);i.width=parseInt(i.width)*this._scaleBit,i.height=parseInt(i.height)*this._scaleBit;var n=i.parentNode.childNodes[3],l=i.getContext("2d"),r=0,o=i.width,h=14*this._scaleBit;l.Num=0,l.timer=null,function t(){0===a&&(l.beginPath(),l.lineWidth=h,l.strokeStyle="#17305a",l.arc(o/2,o/2,o/2-h/2,0,2*Math.PI),l.stroke(),l.fillStyle=s,l.textBaseline="middle",l.font="bold 2.8rem Arial",l.textAlign="center",n.innerHTML='0<span class="bit">%</span>',l.fillText(0,o/2,o/2)),l.clearRect(0,0,i.width,i.height),l.beginPath(),l.lineWidth=h,l.strokeStyle="#17305a",l.arc(o/2,o/2,o/2-h/2,0,2*Math.PI),l.stroke(),l.beginPath(),l.strokeStyle=s,l.Num-a>0&&l.Num-a<=1?(r=(a-25)/50*Math.PI,n.innerHTML=a+'<span class="bit">%</span>'):(r=(l.Num-25)/50*Math.PI,n.innerHTML=l.Num+'<span class="bit">%</span>'),l.arc(o/2,o/2,o/2-h/2,-.5*Math.PI,r),l.stroke(),l.Num-a>0&&l.Num-a<=2?e.cancelAnimationFrame(l.timer):(l.Num+=2,l.timer=e.requestAnimationFrame(t))}()},saleTypeTpl:function(e,t,a,s){return'<dl class="cvs-item" style="width: '+t+"px;margin-right:"+a+'px;">\n                    <dt class="cvs-cnt" style="width:'+t+"px;height: "+t+'px;">\n                        <canvas class="cxt" id="Js_saleType_'+s+'" width="'+t+'" height="'+t+'"></canvas>\n                        <p class="ctx-num"></p>\n                    </dt>\n                    <dd class="typeName eps">'+(e.lineTypeName||"-")+'</dd>\n                    <dd class="num eps">收客'+e.salePerNum+'人</dd>\n                    <dd class="no eps">团队NO.'+(e.saleRanking+1)+"</dd>\n                </dl>"},saleTypeBit:function(){var e=this,t=this.pageDates.chanpin.saleLineTypePercentage||[];t.sort(function(e,t){return t.salePerNumPercentage-e.salePerNumPercentage});var a=t.length,s=0,i=0;a>6?(this.saleTypeBitNodes.removeClass("min"),this.saleTypeBitNodes.css({width:.38*this._ww*Math.ceil(a/2),"padding-left":.025*this._ww}),i=.3*this._ww,s=.08*this._ww):(this.saleTypeBitNodes.addClass("min min-"+a),this.saleTypeBitNodes.css("width",.325*this._ww*Math.ceil(a/2)-.025*this._ww),i=.3*this._ww,s=.025*this._ww);var n="";t.forEach(function(t,a){n+=e.saleTypeTpl(t,i,s,a)}),this.saleTypeBitNodes.html(n);this.saleTypeBitNodes.find(".cxt");var l=0,r=this,o=setInterval(function(){l>=a?clearInterval(o):(r.salePropCvs(l,Number(t[l].salePerNumPercentage),"#725cff"),l++)},100)},unitPrice:function(){var t=this.pageDates.kedan.saleUnitPriceSection||[],a=$("#Js_unitPrice");if(a.show(),t.length<1)return $("#Js_page_noDate_5").show(),a.hide(),!1;$("#Js_page_noDate_5").hide(),t.sort(function(e,t){return t.startAmount-e.startAmount});var s=[this._scaleBit,t.length,50],i=s[0],n=s[1],l=s[2];n=Math.floor(a.parent().parent().height()/l)>n?n:Math.floor(a.parent().height()/l),a.parent().css({width:this._ww,height:n*l});var r=a.get(0);r.width=this._ww*i,r.height=n*l*i;for(var o=r.getContext("2d"),h=15*i,c=25*i,d=l*i,m=r.width-30*i,p=0,u=0,f=null,g=0,w=0;w<n;w++)0===w&&(t[w].text=t[w].startAmount+"以上",g+=100*t[w].saleUnitPriceSection),w>0&&w<n-1&&(t[w].text=t[w].startAmount+"-"+t[w].endAmount,g+=100*t[w].saleUnitPriceSection),w===n-1&&(t[w].saleUnitPriceSection=(1e4-g)/100,t[w].text=t[w].endAmount+"以下"),1*t[w].saleUnitPriceSection>p&&(p=1*t[w].saleUnitPriceSection);var v=o.createLinearGradient(h,0,h+m*p/100,0);v.addColorStop(0,"#5943ff"),v.addColorStop(1,"#ed69c7"),function a(){o.clearRect(0,0,r.width,r.height);for(var s=0;s<n;s++)o.fillStyle="#17305a",o.fillRect(h,c+s*d,m,c),o.fillStyle="#3bccff",o.textBaseline="bottom",o.font=13*i+"px Arial",o.textAlign="start",o.fillText(t[s].text,h,c+s*d),o.fillStyle="#44f8ff",o.textAlign="end",1*t[s].saleUnitPriceSection>u?(o.fillText(u+"%",r.width-h,c+s*d),o.fillStyle=v,o.fillRect(h,c+s*d,m*u/100,c)):(o.fillText(t[s].saleUnitPriceSection+"%",r.width-h,c+s*d),o.fillStyle=v,o.fillRect(h,c+s*d,m*t[s].saleUnitPriceSection/100,c));if(u-p>0&&u-p<=1)return e.cancelAnimationFrame(f),!1;u++,f=e.requestAnimationFrame(a)}()}}.init()}(window);